<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="../../js/spark-md5.js"></script>
  </head>
  <body>
    <input type="file" />

    <script>
      const inp = document.querySelector('input')
      inp.onchange = async e => {
        const file = inp.files[0]
        if (!file) {
          return
        }
        /*
         * è·å–åˆ†ç‰‡ç»“æœ
         *
         * ç–‘é—®ï¼šä¸€ä¸ªéå¸¸å¤§çš„è§†é¢‘ï¼Œæ‰§è¡Œåˆ†ç‰‡å‡½æ•°åå¾—åˆ°å‡ åä¸ªBlobå¯¹è±¡ï¼Œä¸ºå•¥æ‰§è¡Œè¿™ä¹ˆå¿«å‘¢ï¼Ÿ
         * æ–‡ä»¶ä¸æ˜¯å¾ˆå¤šå˜›ï¼Œæ€ä¹ˆç¬é—´å°±å®Œæˆäº†åˆ†ç‰‡å‘¢ ğŸ¤”ï¸
         *
         * æ¶ˆé™¤è¯¯è§£ ğŸ”¥
         *  æ— è®ºæ˜¯Fileå¯¹è±¡è¿˜æ˜¯Blobå¯¹è±¡ï¼Œé‡Œé¢ä¿å­˜çš„æ˜¯æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¹¶æ²¡æœ‰ä¿å­˜æ–‡ä»¶çš„æ•°æ®ä¿¡æ¯
         *  File: size/type/name
         *  Bolb: size/type
         *
         * å…¶å®å¯¹æ–‡ä»¶è¿›è¡Œåˆ†ç‰‡ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªç®€å•çš„æ•°å­¦è¿ç®—è€Œå·²ï¼Œè‹¥éœ€è¦è¯»å–æ–‡ä»¶æ•°æ®ï¼Œä½¿ç”¨FileReaderå³å¯ ğŸ”¥
         */
        const fileChunk = createChunks(file, 1 * 1024 * 1024)
        const res = await hash(fileChunk)
        console.log('æ–‡ä»¶hash' + res)
      }

      /*
       * åˆ†ç‰‡è®¡ç®—hash
       * @æ€è·¯ï¼š
       *   1. å…ˆè¯»å–ç¬¬ä¸€ä¸ªåˆ†å—
       *   2. ç„¶åé€’å½’è°ƒç”¨è‡ªèº«ï¼Œå†è¯»ä¸‹ä¸€ä¸ªåˆ†å—
       * 
       * è®¡ç®—hashæ¯”è¾ƒè€—æ—¶é—´ï¼Œä¸€èˆ¬ä¸ä¼šæ”¾åœ¨ä¸»çº¿ç¨‹è¿›è¡Œï¼Œä¸€èˆ¬ä¼šå•ç‹¬å¼€å¯ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç† ï¼ˆweb workerï¼‰
       * è¿™æ ·é¿å…æµè§ˆå™¨å¡æ­»
       * 
       * https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers
       * https://juejin.cn/post/7139718200177983524
       * 
       * æ”¾åˆ°å•ç‹¬çº¿ç¨‹å¤„ç†ï¼Œå¯èƒ½è¿˜ä¼šå‘ç”Ÿå¡é¡¿ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªCPUå¯†é›†çš„ä»»åŠ¡ï¼Œè§£å†³æ–¹æ¡ˆï¼š
       *  1.å…ˆç²—ç•¥æŠŠæ–‡ä»¶åˆ†ä¸ºå‡ ä¸ªå¤§å—ï¼Œå•ç‹¬è®¡ç®—æ¯ä¸ªå¤§å—çš„hash
       *  2.ç„¶åå†å¯¹å¤§å—åˆ†å°å—ï¼Œè¿›è¡Œæ–‡ä»¶ä¸Šä¼ 
       */
      function hash(chunks) {
        const spark = new SparkMD5()

        return new Promise((resolve, reject) => {
          function _read(i) {
            if (i >= chunks.length) {
              resolve(spark.end())
              return // è¯»å–å®Œæˆ
            }
            // è·å–åˆ†å—æ•°æ®
            const blob = chunks[i]
            const reader = new FileReader()

            // åˆ†ç‰‡æ•°æ®è¯»å–å®Œæˆ
            reader.onload = e => {
              const bytes = e.target.result // è¯»å–åˆ°çš„å­—ç¬¦ä¸²
              // æŠŠè¿™ä¸ªå­—èŠ‚æ•°ç»„ï¼Œä½¿ç”¨å¢é‡hashè®¡ç®—
              spark.append(bytes)
              // è¯»å–ä¸‹ä¸€ä¸ªåˆ†å—
              _read(i + 1)
            }

            // è¯»å–åˆ†å—å­—èŠ‚æ•°
            reader.readAsArrayBuffer(blob)
          }
          _read(0) // é¦–å…ˆè¯»å–ç¬¬ä¸€ä¸ªåˆ†å—
        })
      }

      // åˆ›å»ºåˆ†ç‰‡
      function createChunks(file, chunkSize) {
        const result = []
        for (let i = 0; i < file.size; i += chunkSize) {
          result.push(file.slice(i, i + chunkSize))
        }
        return result
      }
    </script>
  </body>
</html>
